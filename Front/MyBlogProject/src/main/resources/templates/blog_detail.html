<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Document</title>
	<link rel="stylesheet" th:href="@{/css/reset.css}">
	<link rel="stylesheet" th:href="@{/css/detail.css}">
</head>

<body class="bd-body">
	<header class="site-header">
		<div class="container">
			<p class="brand">
			  <a th:href="@{/about}" style="text-decoration:none; color:inherit;">
			    <span class="logo"><span th:text="${userName}"></span>'s</span><span class="brand-text">Blog</span>
			  </a>
			</p>
			<nav id="site-nav" class="nav">
				<ul>
					<li><a th:href="@{/blog/welcome}" class="active">Home</a></li>
					<li><a th:href="@{/blogregister}">Blog Register</a></li>
					<li>
						<form th:action="@{/logout}" method="post">
							<button type="submit" class="logout-btn">Logout</button>
						</form>
					</li>
				</ul>
			</nav>
		</div>
	</header>

	<main class="bd-container bd-main">

		<section class="bd-card">
			<h1 class="bd-title" th:text="${blog.blogTitle}">タイトル</h1>
			<p class="bd-meta">
				<span
					th:text="${blog.createdAt == null ? '-' : #dates.format(blog.createdAt,'yyyy/MM/dd HH:mm')}">2025/01/01</span>
				・<span th:text="${blog.categoryName}"></span>
				・by
				<span th:text="${authorName != null ? authorName : '匿名'}"></span>

			</p>

			<img class="bd-cover" th:if="${blog.blogImage != null}" th:src="@{/blog-img/{f}(f=${blog.blogImage})}"
				alt="cover">

			<article class="bd-article" th:text="${blog.article}">

			</article>
		</section>

		<!-- コメントlist -->
		 <section class="bd-card">
			<h2 class="bd-subtitle">
				コメント
				<small class="bd-meta"
					th:text="${'(' + (#lists.isEmpty(comments) ? 0 : #lists.size(comments)) + ')'}"></small>
			</h2>

			<!-- 根コメント -->
			<div th:if="${comments != null}" th:each="c : ${comments}" class="bd-comment" th:id="${'c-'+c.commentId}">

				<div class="bd-comment__head">
					<div class="bd-comment__who">
						<span class="bd-comment__author" th:text="${commentNames != null and c.accountId != null and #maps.containsKey(commentNames, c.accountId)
		                        ? commentNames[c.accountId] : '匿名'}"></span>
						<span class="bd-comment__time"
							th:text="${c.createdAt == null ? '' : #dates.format(c.createdAt,'yyyy/MM/dd HH:mm')}">time</span>
					</div>

					<div class="bd-comment__actions">
						<form
							th:if="${session.uid != null and (session.uid == blog.accountId or session.uid == c.accountId)}"
							th:action="@{/blog/comments/{cid}/delete(cid=${c.commentId})}" method="post"
							class="bd-inline-form" onsubmit="return confirm('コメントを削除しますか？');">
							<button type="submit" class="bd-btn bd-btn--warn bd-btn--sm">削除</button>
						</form>

						<button type="button" class="bd-btn bd-btn--ghost bd-btn--sm"
							th:attr="data-bd-toggle=${'reply-' + c.commentId}">返信</button>
					</div>
				</div>

				<div class="bd-comment__text" th:text="${c.commentArticle}"></div>

				<img class="bd-comment__image" th:if="${c.commentImage != null}"
					th:src="@{/comment-img/{f}(f=${c.commentImage})}" alt="comment image">

				<div class="bd-replies" th:if="${repliesMap != null and #maps.containsKey(repliesMap, c.commentId)}">
					<div class="bd-comment bd-comment--child" th:each="r : ${repliesMap[c.commentId]}"
						th:id="${'c-'+r.commentId}">
						<div class="bd-comment__head">
							<div class="bd-comment__who">
								<span class="bd-comment__author" th:text="${commentNames != null and r.accountId != null and #maps.containsKey(commentNames, r.accountId)
		                            ? commentNames[r.accountId] : '匿名'}">匿名</span>
								<span class="bd-comment__time"
									th:text="${r.createdAt == null ? '' : #dates.format(r.createdAt,'yyyy/MM/dd HH:mm')}">time</span>
							</div>
							<div class="bd-comment__actions">
								<form
									th:if="${session.uid != null and (session.uid == blog.accountId or session.uid == r.accountId)}"
									th:action="@{/blog/comments/{cid}/delete(cid=${r.commentId})}" method="post"
									class="bd-inline-form" onsubmit="return confirm('コメントを削除しますか？');">								
									<button type="submit" class="bd-btn bd-btn--warn bd-btn--sm">削除</button>
								</form>
							</div>
						</div>
						<div class="bd-comment__text" th:text="${r.commentArticle}"></div>
						<img class="bd-comment__image" th:if="${r.commentImage != null}"
							th:src="@{/comment-img/{f}(f=${r.commentImage})}" alt="comment image">
					</div>
				</div>

				<form class="bd-reply" th:id="${'reply-'+c.commentId}"
					th:action="@{/blog/{blogId}/comments(blogId=${blog.blogId})}" method="post"
					enctype="multipart/form-data" style="display:none">

					<input type="hidden" name="blogId" th:value="${blog.blogId}">
					<input type="hidden" name="parentCommentId" th:value="${c.commentId}">
					<textarea class="bd-textarea" name="commentArticle" placeholder="返信を入力…"></textarea>
					<div class="bd-actions">
						<input type="file" name="commentImage" accept="image/*">
						<button type="submit" class="bd-btn bd-btn--primary bd-btn--sm">返信を投稿</button>
					</div>
				</form>
			</div>
			</section>

			<!-- コメント -->
			<section class="bd-card">
				<h2 class="bd-subtitle">コメントを書く</h2>

				<div th:if="${session.uid == null}" class="bd-hint">
					コメントするには <a th:href="@{/login}">ログイン</a> してください。
				</div>

				<form th:if="${session.uid != null}" th:action="@{/blog/{blogId}/comments(blogId=${blog.blogId})}"
					method="post" enctype="multipart/form-data">
					<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
						th:value="${_csrf.token}">
					<input type="hidden" name="blogId" th:value="${blog.blogId}">
					<textarea class="bd-textarea" name="commentArticle" placeholder="コメントを入力…" required></textarea>
					<div class="bd-actions">
						<input type="file" name="commentImage" accept="image/*">
						<button type="submit" class="bd-btn bd-btn--primary">投稿</button>
					</div>
				</form>
			</section>
	</main>

	<footer class="bd-footer">
		<div class="bd-container">
			<small>Copyright &copy; SMH All rights reserved</small>
		</div>
	</footer>

	<script>

		document.addEventListener('click', e => {
			if (e.target.matches('[data-bd-toggle]')) {
				const id = e.target.getAttribute('data-bd-toggle');
				const box = document.getElementById(id);
				if (box) box.style.display = (box.style.display === 'block') ? 'none' : 'block';
			}
		});
	</script>
</body>

</html>